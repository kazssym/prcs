#!/usr/bin/make -f
# -*- Makefile -*-
#
# File: rules
# Description: debian/rules file for the prcs package
# Author: Rafael Laboissiere <rafael@icp.inpg.fr>
#         (with help from Samuel Tardieu <sam@debian.org>)
# Created on: Thu Nov  5 15:42:22 CET 1998
# $Id$

package		= prcs

# The following scheme for definitions was stollen from the Debian
# octave package by Dirk Eddelbuetel <dirk@debian.org>
debbase		:= $(shell pwd)/debian
debtmp		:= $(debbase)/tmp
debusr 		:= $(debtmp)/usr
debbin 		:= $(debusr)/bin
debshr 		:= /usr/share
debman		:= $(debshr)/man
debinf		:= $(debshr)/info
deblsp		:= /usr/share/emacs/site-lisp/$(package)
debema		:= $(debusr)/lib/emacsen-common/packages
debest		:= $(debtmp)/etc/emacs/site-start.d/
contribdir	:= contrib

build: build-stamp
build-stamp:
	dh_testdir

	./configure --prefix=/usr --disable-environment --disable-debug
# Use EMACS=no on the command line to avoid useless compilation of
# .elc files
	make EMACS=no
	pod2man $(contribdir)/prcs-synch > $(debbase)/man/prcs-synch.1
	pod2man --section=1 --center="PRCS" --date=2001-10-28 \
          $(debbase)/man/prcsutils.pod > $(debbase)/man/prcs-utils.1 
	( cd $(contribdir) ; \
          for p in rprcs visualtree prcsutils ; do \
	    tar xfz $$p.tar.gz ; \
          done ; \
          rm -f prcsutils/prcsutils.prj ; \
          perl -pi -e \
               's|\./(prcs_tree.pl)|prcs_tree_info|;s|(/.*)+/(xvcg)|$$2|' \
               visualtree/prcs_tree_draw )
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp

	if [ -f Makefile ]; then make distclean; fi

	( cd $(debbase)/man ; rm -f prcs-synch.1 prcs-utils.1 )
	for p in rprcs visualtree prcsutils ; \
          do rm -rf $(contribdir)/$$p ; \
        done
	dh_clean

install: install-stamp
install-stamp: build-stamp
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	make install EMACS=no DESTDIR=$(debtmp) lispdir=$(deblsp) \
	  mandir=$(debman) infodir=$(debinf)
	( cd $(debtmp)/$(deblsp) ; rm -f prcs-ediff.el* *.elc )
	chmod +x $(debbase)/fix-perl-path.pl
	( cd $(contribdir) ; \
	  for i in *-command ; do \
            install -c --mode=0755 $$i $(debbin)/prcs-$$i ; \
          done ; \
          for i in prcs-callback prcs-clean prcs-emerge prcs-ediff \
                   prcs-synch visualtree/prcs_tree_info.pl \
                   visualtree/prcs_tree_draw prcsutils/prcs*; do \
            install -c --mode=0755 $$i $(debbin)/`basename $$i .pl` ; \
            $(debbase)/fix-perl-path.pl $(debbin)/`basename $$i .pl` ; \
	  done ;\
          for i in rprcs/rprcs prcs-javadoc ; do \
            install -c --mode=0755 $$i $(debbin) ; \
          done )

	dh_installman -A
	dh_movefiles -i

# Do this hack until Bug#17111 is fixed - R.L.
	( cd $(debtmp) ; rm -rf etc usr/lib usr/share/emacs )
	touch install-stamp

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installdocs -i
	dh_installemacsen -i
	dh_installchangelogs -i emacs/1.60.log
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_perl -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a
	dh_installchangelogs -a ChangeLog
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_makeshlibs -a
	dh_md5sums -a
	dh_builddeb -a

source diff:                                                                  
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary
